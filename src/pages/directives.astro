---
import Base from "@/layouts/Base.astro";
import { getCollection } from "astro:content";

const allDirectives = await getCollection("directives");
const directives = allDirectives.sort((a, b) => a.data.id.localeCompare(b.data.id));

const directivesWithContent = await Promise.all(
  directives.map(async (directive) => ({
    ...directive,
    renderedContent: await directive.render()
  }))
);
---

<Base title="CSN Directives — LOSS DISFUNCTION" description="Civil Synthesis Network regulatory documents, directives, and public health bulletins.">
  <section class="relative overflow-hidden min-h-screen bg-gray-100 p-8">
    <!-- Floating Menu -->
    <nav class="fixed left-4 top-24 w-56 bg-white border-2 border-gray-800 shadow-lg max-h-[calc(100vh-120px)] overflow-y-auto z-50 hidden md:block">
      <h3 class="p-3 bg-gray-800 text-white text-sm font-bold uppercase">Directives</h3>
      <ul class="list-none p-0 m-0">
        {directivesWithContent.map((directive, index) => (
          <li class="border-b border-gray-200">
            <a href={`#directive-${index}`} class="block p-3 text-xs text-gray-900 no-underline hover:bg-gray-100">
              {directive.data.id}: {directive.data.title.substring(0, 30)}{directive.data.title.length > 30 ? '...' : ''}
            </a>
          </li>
        ))}
      </ul>
    </nav>

    <div class="max-w-4xl ml-0 md:ml-64 mr-auto px-4">
      {directivesWithContent.map((directive, index) => (
        <article class="bg-white shadow-md p-10 mb-8" id={`directive-${index}`}>
          <!-- Document Header -->
          <header class="border-b-2 border-black pb-4 mb-8">
            <div class="text-2xl font-bold uppercase tracking-wide mb-4">{directive.data.title}</div>
            <div class="flex flex-wrap gap-4 text-xs text-gray-600 font-mono">
              <span>ID: {directive.data.id}</span>
              <span>Category: {directive.data.category}</span>
              <span>Year: {directive.data.year}</span>
              <span>Status: {directive.data.status}</span>
              <span>Classification: {directive.data.classification}</span>
              {directive.data.issuedBy && <span>Issued By: {directive.data.issuedBy}</span>}
            </div>
          </header>

          <!-- Document Body -->
          <div class="prose prose-lg max-w-none text-gray-900">
            <directive.renderedContent.Content />
          </div>

          <!-- Document Footer -->
          <footer class="border-t-2 border-black mt-8 pt-4 text-center text-xs text-gray-600">
            <p>CSN Official Document • Classification: {directive.data.classification} • {directive.data.year}</p>
            <p>Civil Synthesis Network • All Rights Reserved</p>
          </footer>
        </article>
      ))}
    </div>
  </section>
</Base>
