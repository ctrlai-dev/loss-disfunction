---
import Base from "@/layouts/Base.astro";
import BackgroundMist from "@/components/BackgroundMist.astro";
import { getCollection } from "astro:content";

// Load directives collection, sort by ID
const allDirectives = await getCollection("directives");
const directives = allDirectives.sort((a, b) => a.data.id.localeCompare(b.data.id));

// Pre-render all directive content
const directivesWithContent = await Promise.all(
  directives.map(async (directive) => ({
    ...directive,
    renderedContent: await directive.render()
  }))
);
---

<style>
  /* Subtle console grid + glow */
  .grid-bg {
    background-image:
      radial-gradient(transparent 1px, rgba(12,12,18,0.4) 1px),
      radial-gradient(transparent 1px, rgba(12,12,18,0.4) 1px);
    background-size: 24px 24px, 24px 24px;
    background-position: 0 0, 12px 12px;
  }
  .chip {
    @apply inline-flex items-center rounded px-2 py-0.5 text-[10px] font-mono tracking-wide;
  }
  .chip-green { 
    background-color: rgba(34, 197, 94, 0.15);
    color: rgb(22, 163, 74);
    border: 1px solid rgba(34, 197, 94, 0.3);
  }
  .chip-cyan { 
    background-color: rgba(59, 130, 246, 0.15);
    color: rgb(37, 99, 235);
    border: 1px solid rgba(59, 130, 246, 0.3);
  }
  .chip-amber { 
    background-color: rgba(245, 158, 11, 0.15);
    color: rgb(217, 119, 6);
    border: 1px solid rgba(245, 158, 11, 0.3);
  }
  .chip-red { 
    background-color: rgba(239, 68, 68, 0.15);
    color: rgb(220, 38, 38);
    border: 1px solid rgba(239, 68, 68, 0.3);
  }
  .chip-blue { 
    background-color: rgba(59, 130, 246, 0.15);
    color: rgb(37, 99, 235);
    border: 1px solid rgba(59, 130, 246, 0.3);
  }

  details[open] summary .caret { transform: rotate(90deg); }
  summary::-webkit-details-marker { display: none; }

  /* Override prose-invert for light backgrounds - MAXIMUM CONTRAST */
  .prose-invert,
  .prose-invert *,
  .prose-invert p,
  .prose-invert div,
  .prose-invert span {
    color: #000000 !important;
  }
  
  .prose-invert h1,
  .prose-invert h2,
  .prose-invert h3,
  .prose-invert h4,
  .prose-invert h5,
  .prose-invert h6 {
    color: #000000 !important;
    font-weight: 700 !important;
  }
  
  .prose-invert strong,
  .prose-invert b {
    color: #000000 !important;
    font-weight: 700 !important;
  }
  
  .prose-invert em,
  .prose-invert i {
    color: #000000 !important;
    font-style: italic !important;
  }
  
  .prose-invert blockquote,
  .prose-invert blockquote p {
    color: #000000 !important;
    margin: 0 !important;
  }
  
  .prose-invert a {
    color: #0000ff !important;
    text-decoration: underline !important;
  }
  
  .prose-invert a:hover {
    color: #000080 !important;
    text-decoration: underline !important;
  }
</style>

<Base title="CSN Directives — LOSS DISFUNCTION" description="Civil Synthesis Network regulatory documents, directives, and public health bulletins.">
  <section class="relative overflow-hidden min-h-screen dark:bg-[#050507]">
    <BackgroundMist />

    <div class="container relative z-10 mx-auto max-w-4xl py-12">
      <h1 class="text-4xl font-bold mb-2" style="color: var(--ink);">CSN Directives</h1>
      <p class="mb-8" style="color: var(--muted);">Official Civil Synthesis Network regulatory documents, directives, and public health bulletins. <span style="color: var(--cyan);">Active as of 2070</span>.</p>

      <div class="space-y-4">
        {directivesWithContent.map((directive) => (
          <details class="group rounded-xl border border-[#1a1a26] bg-[#0b0b12] backdrop-blur p-4 open:shadow-lg open:shadow-cyan-500/20 transition-shadow" id={directive.slug}>
            <summary class="flex cursor-pointer items-start justify-between gap-4">
              <div>
                <div class="flex flex-wrap items-center gap-2">
                  <span class="text-lg font-semibold" style="color: var(--ink);">{directive.data.title}</span>
                  <span class="chip chip-cyan">{directive.data.year}</span>
                  <span class={`chip ${
                    directive.data.classification === "RESTRICTED" ? "chip-red" :
                    directive.data.classification === "CONFIDENTIAL" ? "chip-amber" :
                    directive.data.classification === "INTERNAL" ? "chip-blue" :
                    "chip-green"}`}>
                    {directive.data.classification}
                  </span>
                  <span class="chip chip-green">{directive.data.status}</span>
                </div>
                <div class="text-xs mt-1" style="color: var(--muted);">
                  ID: {directive.data.id} • Category: {directive.data.category}
                  {directive.data.issuedBy && ` • Issued by: ${directive.data.issuedBy}`}
                </div>
              </div>
              <div class="caret mt-1 transition-transform" style="color: var(--cyan);">▸</div>
            </summary>

            <div class="prose prose-invert max-w-none mt-4">
              <directive.renderedContent.Content />
              <div class="mt-4 flex items-center gap-3 text-xs" style="color: var(--muted);">
                <span class="chip chip-cyan">CSN Official Document</span>
                <span class="chip chip-green">Public Distribution</span>
              </div>
            </div>
          </details>
        ))}
      </div>

      <footer class="mt-12 border-t border-[#1a1a26] pt-6 text-xs" style="color: var(--muted);">
        Civil Synthesis Network • <span style="color: var(--cyan);">Active Directives 2070</span> • Compliance Mandatory
      </footer>
    </div>
  </section>
</Base>
